---
import { getCollection } from "astro:content";
import { CaseStudiesTabs } from "./case-studies/CaseStudiesTabs";
import { MotionLayoutWrapper } from "./MotionLayoutWrapper";
import { mdToHtml } from "@/utils/markdown";

interface Props {
  data: {
    heading: string;
    items: any[];
  };
}

const { data } = Astro.props;

// Extract tab from URL hash if present
function getInitialTabFromURL(url: string) {
  try {
    if (url && url.includes("#pripadove-studie")) {
      const hashPart = url.split("#pripadove-studie")[1] || "";
      if (hashPart.includes("?tab=")) {
        const params = new URLSearchParams(hashPart.split("?")[1] || "");
        return params.get("tab");
      }
    }
  } catch (e) {
    // Ignore URL parsing errors
  }
  return null;
}

// Helper to convert image object to plain src URL
function processImage(image: any) {
  if (!image) return undefined;
  // Handle both { src: string } objects and string URLs
  if (typeof image === "string") return { src: image };
  return { src: image.src };
}

// Process Case Studies - serialize image objects to plain URLs for React islands
const processedStudies = data.items.map((study) => ({
  tabLabel: study.tabLabel,
  heading: study.heading,
  description: study.description,
  metrics: study.metrics || [],
  testimonial: study.testimonial
    ? {
        quote: study.testimonial.quote,
        avatar: processImage(study.testimonial.avatar),
        clientLogo: processImage(study.testimonial.clientLogo),
        name: study.testimonial.name || "",
        role: study.testimonial.role || "",
      }
    : undefined,
}));

// Fetch Testimonials (Still separate collection)
const testimonials = await getCollection("testimonials");
const processedTestimonials = testimonials.map((t) => ({
  content: mdToHtml(t.data.content),
  avatar: processImage(t.data.avatar),
  logo: processImage(t.data.logo),
  name: t.data.name || "",
  role: t.data.role || "",
}));

const initialTab = getInitialTabFromURL(Astro.url.href);
---

<section
  id="pripadove-studie"
  class="bg-white pt-24 pb-2.5"
  data-sb-object-id="src/content/pages/homepage.json"
>
  <div class="container">
    <h2
      class="text-2xl font-brand-heading text-brand-dark text-center mb-8 sm:mb-12 reveal-text"
      data-delay="0"
      data-sb-field-path="caseStudies.heading"
    >
      {data.heading}
    </h2>

    <div class="reveal-card" data-delay="100">
      <MotionLayoutWrapper>
        <CaseStudiesTabs
          client:visible
          studies={processedStudies}
          testimonials={processedTestimonials}
          initialTab={initialTab}
        />
      </MotionLayoutWrapper>
    </div>
  </div>
</section>
