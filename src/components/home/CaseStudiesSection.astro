---
import { getCollection } from "astro:content";
import { mdToHtml } from "@/utils/markdown";
import { CaseStudiesTabs } from "./case-studies/CaseStudiesTabs";
import { MotionLayoutWrapper } from "./MotionLayoutWrapper";

interface Props {
  data: {
    heading: string;
    items: any[];
  };
}

const { data } = Astro.props;

// Extract tab from URL hash if present
function getInitialTabFromURL(url: string) {
  try {
    if (url && url.includes("#pripadove-studie")) {
      const hashPart = url.split("#pripadove-studie")[1] || "";
      if (hashPart.includes("?tab=")) {
        const params = new URLSearchParams(hashPart.split("?")[1] || "");
        return params.get("tab");
      }
    }
  } catch (e) {
    // Ignore URL parsing errors
  }
  return null;
}

// Process Case Studies
const processedStudies = data.items.map((study) => {
  const html = mdToHtml(study.description);

  return {
    ...study,
    descriptionHtml: html,
  };
});

// Fetch Testimonials (Still separate collection)
const testimonials = await getCollection("testimonials");
const processedTestimonials = testimonials.map((t) => ({
  ...t.data,
  content: mdToHtml(t.data.content),
}));

const initialTab = getInitialTabFromURL(Astro.url.href);
---

<section
  id="pripadove-studie"
  class="bg-white pt-24 pb-2.5"
  data-sb-object-id="src/content/pages/homepage.json"
>
  <div class="container mx-auto px-6">
    <h2
      class="text-2xl font-brand-heading text-brand-dark text-center mb-12 reveal-text"
      data-delay="0"
      data-sb-field-path="caseStudies.heading"
    >
      {data.heading}
    </h2>

    <div class="reveal-card" data-delay="100">
      <MotionLayoutWrapper>
        <CaseStudiesTabs
          client:visible
          studies={processedStudies}
          testimonials={processedTestimonials}
          initialTab={initialTab}
        />
      </MotionLayoutWrapper>
    </div>
  </div>
</section>
