---
import { getEntry, getCollection } from "astro:content";
import Markdoc from "@markdoc/markdoc";
import { CaseStudiesTabs } from "./case-studies/CaseStudiesTabs";
import { MotionLayoutWrapper } from "./MotionLayoutWrapper";

// Extract tab from URL hash if present
function getInitialTabFromURL(url: string) {
  try {
    if (url && url.includes("#pripadove-studie")) {
      const hashPart = url.split("#pripadove-studie")[1] || "";
      if (hashPart.includes("?tab=")) {
        const params = new URLSearchParams(hashPart.split("?")[1] || "");
        return params.get("tab");
      }
    }
  } catch (e) {
    // Ignore URL parsing errors
  }
  return null;
}

// 1. Fetch Data
const entry = await getEntry("caseStudies", "case-studies");
if (!entry) return null;

const { heading, items = [] } = entry.data;

// 2. Process Case Studies (Parse Markdoc on Server)
const processedStudies = items.map((study) => {
  const ast = Markdoc.parse(study.description);
  const content = Markdoc.transform(ast);
  const html = Markdoc.renderers.html(content);

  return {
    ...study,
    descriptionHtml: html, // Pass HTML string to React
  };
});

// 3. Fetch Testimonials
const testimonials = await getCollection("testimonials");
const processedTestimonials = testimonials.map((t) => t.data);

// 4. Get initial tab from URL
const initialTab = getInitialTabFromURL(Astro.url.href);
---

<section id="pripadove-studie" class="bg-white pt-24 pb-2.5">
  <div class="container mx-auto px-6">
    <h2
      class="text-2xl font-brand-heading text-brand-dark text-center mb-12 reveal-text"
      data-delay="0"
    >
      {heading}
    </h2>

    <!-- Mount React Island with layout animation -->
    <div class="reveal-card" data-delay="100">
      <MotionLayoutWrapper>
        <CaseStudiesTabs
          client:visible
          studies={processedStudies}
          testimonials={processedTestimonials}
          initialTab={initialTab}
        />
      </MotionLayoutWrapper>
    </div>
  </div>
</section>