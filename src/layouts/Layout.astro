---
import "../styles/global.css";
import Header from "@/components/layout/Header.astro";
import Footer from "@/components/layout/Footer.astro";
import { getEntry } from "astro:content";
import ReactModalProvider from "@/components/home/ContactModalProvider";

// 1. Fetch contacts data
const contactsEntry = await getEntry("contacts", "contacts");
const featuredPeople = contactsEntry?.data?.team?.filter((p: any) => p.isFeatured) || contactsEntry?.data?.team?.slice(0, 1) || [];

interface Props {
  title?: string;
  description?: string;
}

const {
  title = "Sítovka.net | Marketingová Agentura",
  description = "Marketing and Creative Agency",
} = Astro.props;
---

<!doctype html>
<html lang="cs" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <meta name="description" content={description} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- Adobe Fonts / Typekit -->
    <link rel="stylesheet" href="https://use.typekit.net/rsm7rew.css" />

    <title>{title}</title>
  </head>
  <body class="bg-white text-brand-dark antialiased mx-5 mb-5">
    <!-- Header -->
    <Header />

    <!-- Main Content -->
    <main class="pt-36">
      <slot />
    </main>

    <!-- Footer -->
    <Footer />

    <!-- Contact Modal Provider (React Island) -->
    {featuredPeople.length > 0 && (
      <ReactModalProvider
        client:load
        featuredPeople={featuredPeople}
        contactsSectionId="kontakty"
      />
    )}

    <!-- INTERSECTION OBSERVER SCRIPT -->
    <script is:inline define:vars={{ featuredPeopleCount: featuredPeople.length }}>
      const ANIMATIONS_ENABLED = true;

      document.addEventListener("DOMContentLoaded", () => {
        if (!ANIMATIONS_ENABLED) {
          document
            .querySelectorAll(".reveal-text, .reveal-card, .reveal-img")
            .forEach((el) => {
              el.classList.add("active");
            });
          return;
        }

        const observerOptions = {
          root: null,
          rootMargin: "0px 0px -10px 0px",
          threshold: 0.15,
        };

        const observer = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              if (entry.target instanceof HTMLElement) {
                const el = entry.target;
                const delay = el.dataset.delay || "0";

                el.style.transitionDelay = `${delay}ms`;

                requestAnimationFrame(() => {
                  el.classList.add("active");
                });

                observer.unobserve(el);
              }
            }
          });
        }, observerOptions);

        const targets = document.querySelectorAll(
          ".reveal-text, .reveal-card, .reveal-img",
        );
        targets.forEach((el) => observer.observe(el));
      });

      // Modal Trigger Handler
      const handlePoptavkaClick = (e) => {
        const target = e.target;
        const anchor = target.closest('a[href="#poptavka"]');
        
        if (!anchor) return;

        e.preventDefault();

        // Open modal immediately (skip scroll)
        const event = new CustomEvent("open-poptavka-modal");
        window.dispatchEvent(event);
      };

      // Attach event listeners to all #poptavka links
      document.addEventListener("click", handlePoptavkaClick);

      // Handle hash-based navigation for #pripadove-studie?tab=reference links
      document.addEventListener("click", (e) => {
        const anchor = e.target.closest('a[href^="#pripadove-studie"]');
        if (!anchor) return;

        e.preventDefault();
        
        const href = anchor.getAttribute("href") || "";
        const hash = href.split("?")[0];
        const params = new URLSearchParams(href.split("?")[1] || "");
        const tab = params.get("tab");
        
        // Update URL without triggering hashchange immediately
        window.history.pushState(null, "", href);
        
        // Scroll to section with offset for fixed header
        const section = document.querySelector(hash);
        if (section) {
          const headerHeight = 144; // h-36 = 144px
          const elementPosition = section.getBoundingClientRect().top + window.pageYOffset;
          const offsetPosition = elementPosition - headerHeight;
          
          window.scrollTo({
            top: offsetPosition,
            behavior: "smooth",
          });
        }
        
        // Dispatch event for tab change if tab is specified
        if (tab) {
          const event = new CustomEvent("pripadove-studie-tab-change", {
            detail: { tab }
          });
          document.dispatchEvent(event);
        }
      });
      
      // Listen for hash changes (e.g., back/forward buttons)
      window.addEventListener("hashchange", () => {
        const hash = window.location.hash;
        if (hash.startsWith("#pripadove-studie")) {
          const params = new URLSearchParams(hash.split("?")[1] || "");
          const tab = params.get("tab");
          
          if (tab) {
            const event = new CustomEvent("pripadove-studie-tab-change", {
              detail: { tab }
            });
            document.dispatchEvent(event);
          }
        }
      });

      // Handle initial page load with hash
      if (window.location.hash.startsWith("#pripadove-studie")) {
        setTimeout(() => {
          const params = new URLSearchParams(window.location.hash.split("?")[1] || "");
          const tab = params.get("tab");
          
          if (tab) {
            const event = new CustomEvent("pripadove-studie-tab-change", {
              detail: { tab }
            });
            document.dispatchEvent(event);
          }
        }, 100);
      }
    </script>
  </body>
</html>
